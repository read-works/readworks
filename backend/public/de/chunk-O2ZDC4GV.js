import{a as u}from"./chunk-5ESBBNVT.js";import{_a as i,g as r,hb as h,s as c,w as l}from"./chunk-V52KVE3Z.js";var d="desc",m="date",p="lastDocumentSearch",g=64,b=(()=>{class o{http=l(h);socket=l(u);filterSettings={sortDirection:d,sortByType:m};contextCaseId;importQueue=[];importsInProgress=0;documentProcessingInfo={};processing=new r;relevantChange=new r;documentCount=new r;errors=new r;importCompleted=new r;allCaseDocuments=[];relevantCaseDocuments=[];removedIds=[];errorCollector=[];$loadFilteredDocumentsByCaseId;constructor(){this.resetFilter(),this.handleProcessingUpdates()}setCaseId(e){this.contextCaseId=e,this.loadAllDocumentsByCaseId(),this.readLatestFilterSettings()}addToImportQueue(e){this.contextCaseId&&(this.importQueue.push({caseId:this.contextCaseId,file:e}),this.importsInProgress<g&&this.runImportQueue())}setFilter(e){this.filterSettings=e,this.persistFilterSettings(),this.loadFilteredDocumentsByCaseId()}getFilter(){return this.filterSettings}resetFilter(){this.filterSettings={sortDirection:d,sortByType:m},this.persistFilterSettings(),this.loadFilteredDocumentsByCaseId()}loadFilteredDocumentsByCaseId(){this.contextCaseId&&!this.$loadFilteredDocumentsByCaseId&&(this.$loadFilteredDocumentsByCaseId=this.http.get(`${i.api}case/${this.contextCaseId.toString()}/documents${this.getFilterString()}`),this.$loadFilteredDocumentsByCaseId.subscribe(e=>{this.relevantCaseDocuments=e.filter(t=>!this.removedIds.includes(t.id)),this.addToAllDocuments(),this.relevantChange.next(this.relevantCaseDocuments),requestAnimationFrame(()=>{delete this.$loadFilteredDocumentsByCaseId})}))}fetchDocumentById(e){return this.http.get(`${i.api}document/${e}`)}fetchPage(e,t){return this.http.get(`${i.api}document/${e}/pages/${t}`)}fetchPages(e,t={filters:[],operator:"and"},s=0,a=-1){let n="?filter=";return t.filters.length?(n+=t.filters.toString(),n+="&operator="+t.operator,t.matchWord&&(n+="&matchWord="+t.matchWord)):n="?",this.http.get(`${i.api}document/${e}/pages${n}&fromPageNumber=${s}&loadNext=${a}`)}subscribeToProcessingUpdates(){return this.processing}subscribeToRelevantChanges(){return this.relevantChange}subscribeToDocumentCounter(){return this.documentCount}subscribeToErrors(){return this.errors}subscribeToImportCompleted(){return this.importCompleted}delete(e){this.removedIds.push(e),this.preEstablishDeletion(e),this.http.delete(`${i.api}document/${e}`).subscribe()}destroyCaches(){this.contextCaseId=void 0,this.removedIds=[],this.errorCollector=[],this.allCaseDocuments=[],this.relevantCaseDocuments=[],this.documentCount.next(this.allCaseDocuments.length),this.resetFilter()}runImportQueue(){if(this.importQueue.length){let e=this.importQueue.pop();this.importsInProgress++,this.import(e.caseId,e.file).subscribe(t=>{t.error?this.handleImportError(t):this.loadFilteredDocumentsByCaseId()})}}import(e,t){let s=new FormData;return s.set("caseId",e.toString()),s.set("filename",t.name),s.append("file",t),this.http.post(`${i.api}document`,s)}loadAllDocumentsByCaseId(){this.contextCaseId&&this.http.get(`${i.api}case/${this.contextCaseId.toString()}/documents`).subscribe(e=>{this.allCaseDocuments=e,this.documentCount.next(e.length)})}handleProcessingUpdates(){this.socket.fromEvent("processingDocument").subscribe(e=>{this.documentProcessingInfo[e.documentId]||this.loadFilteredDocumentsByCaseId(),this.documentProcessingInfo[e.documentId]=e.percentCompleted,this.documentProcessingInfo[e.documentId]===1&&(delete this.documentProcessingInfo[e.documentId],this.importsInProgress>0&&(this.importsInProgress--,this.loadFilteredDocumentsByCaseId()),this.continueImportQueue()),this.processing.next(this.documentProcessingInfo)})}preEstablishDeletion(e){this.allCaseDocuments.some((t,s)=>(e===t.id&&this.allCaseDocuments.splice(s,1),e===t.id)),this.relevantCaseDocuments.some((t,s)=>(e===t.id&&this.relevantCaseDocuments.splice(s,1),e===t.id)),this.relevantChange.next(this.relevantCaseDocuments),this.documentCount.next(this.allCaseDocuments.length)}persistFilterSettings(){sessionStorage.setItem(p,JSON.stringify(this.filterSettings))}continueImportQueue(){this.importQueue.length?this.runImportQueue():(console.log("Queue size: ",this.importsInProgress),this.importsInProgress===0&&(console.log("Queue empty"),this.errorCollector.length?(console.log(this.errorCollector),this.errors.next(JSON.parse(JSON.stringify(this.errorCollector))),this.errorCollector=[]):this.importCompleted.next(),this.loadFilteredDocumentsByCaseId()))}readLatestFilterSettings(){let e=JSON.parse(sessionStorage.getItem(p)+"");e&&this.setFilter(e)}getFilterString(){let e="?";return this.getFilter()?.searchForName&&(e+=`name=${this.getFilter().searchForName}&`),e+=`sortBy=${this.getFilter().sortByType}&`,e+=`direction=${this.getFilter().sortDirection}`,e}addToAllDocuments(){this.relevantCaseDocuments.forEach(e=>{let t=e.id;!this.allCaseDocuments.some(a=>t===a.id)&&e.processed&&(this.allCaseDocuments.push(e),this.documentCount.next(this.allCaseDocuments.length))})}handleImportError(e){this.errorCollector.push(e),this.importsInProgress--,this.continueImportQueue()}static \u0275fac=function(t){return new(t||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();export{b as a};
/**i18n:1964dde12af7df15d0053ab7761c4e4c56fe7eae085ef9e01bc7588ce5d2189d*/
